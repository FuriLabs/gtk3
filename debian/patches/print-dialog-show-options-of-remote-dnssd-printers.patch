From: Ubuntu Developers <ubuntu-devel-discuss@lists.ubuntu.com>
Date: Thu, 13 Dec 2018 18:00:42 -0500
Subject: print-dialog-show-options-of-remote-dnssd-printers

Bug-Upstream: https://bugzilla.gnome.org/show_bug.cgi?id=684533
---
 modules/printbackends/cups/gtkprintbackendcups.c | 20 ++++++++++++++++++++
 1 file changed, 20 insertions(+)

diff --git a/modules/printbackends/cups/gtkprintbackendcups.c b/modules/printbackends/cups/gtkprintbackendcups.c
index bbe01c9..20887a3 100644
--- a/modules/printbackends/cups/gtkprintbackendcups.c
+++ b/modules/printbackends/cups/gtkprintbackendcups.c
@@ -2463,6 +2463,13 @@ cups_printer_handle_attribute (GtkPrintBackendCups *cups_backend,
     }
 }
 
+/* Lifted directly from CUPS private headers. We probably should have found
+ * a less fragile approach, I guess?  */
+extern const char	*_httpResolveURI(const char *uri, char *resolved_uri,
+			                 size_t resolved_size, int options,
+					 int (*cb)(void *context),
+					 void *context) _CUPS_PRIVATE;
+
 static GtkPrinter*
 cups_create_printer (GtkPrintBackendCups *cups_backend,
 		     PrinterSetupInfo *info)
@@ -2521,6 +2528,19 @@ cups_create_printer (GtkPrintBackendCups *cups_backend,
 		   &port,
 		   resource, sizeof (resource));
 
+  if (strncmp (method, "dnssd", 5) == 0)
+    {
+      _httpResolveURI(cups_printer->printer_uri,
+		      uri, sizeof(uri), 0, NULL, NULL);
+      httpSeparateURI (HTTP_URI_CODING_ALL,
+		       uri,
+		       method, sizeof (method),
+		       username, sizeof (username),
+		       hostname, sizeof (hostname),
+		       &port,
+		       resource, sizeof (resource));
+    }
+
   if (strncmp (resource, "/printers/", 10) == 0)
     {
       cups_printer->ppd_name = g_strdup (resource + 10);
